name: "Deploy Gate (Attestation Verification)"

# This workflow is the enforcement step that makes all signing meaningful.
# Without verifying attestations at deploy time, signing is a paper trail — not a control.
#
# Trigger this workflow before every deployment:
#   - Manually via workflow_dispatch with the image digest to deploy
#   - Or call it as a required job from your deploy workflow using workflow_call
#
# Verification chain (all must pass before deployment proceeds):
#   1. cosign signature        — image was built by THIS workflow, not pushed directly
#   2. SLSA provenance         — build inputs (commit, repo, workflow) are recorded
#   3. SBOM attestation        — a bill of materials exists for this exact image
#
# If any check fails, the deployment is blocked.

on:
  workflow_dispatch:
    inputs:
      image_digest:
        description: "Image digest to deploy (sha256:abc...)"
        required: true
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options: [staging, production]

  # Allow other workflows to call this as a required gate
  workflow_call:
    inputs:
      image_digest:
        description: "Image digest to deploy (sha256:abc...)"
        required: true
        type: string
      environment:
        description: "Target environment"
        required: true
        type: string

permissions:
  contents: read
  id-token: write   # needed by cosign for keyless verification

jobs:
  verify-attestations:
    name: verify supply chain attestations
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    env:
      # Build the full digest reference once — reused in every verification step
      IMAGE_REF: ghcr.io/${{ github.repository }}@${{ inputs.image_digest }}

    steps:
      - name: checkout (for workflow identity in cosign verify)
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
        with:
          persist-credentials: false

      - name: install cosign
        uses: sigstore/cosign-installer@1aa8e0f2454b781fbf0fbf306a4c9533a0c57409 # v3.7.0

      # ── Gate 1: cosign signature ───────────────────────────────────────────────
      # Proves the image was signed by build-sign.yaml running in THIS repo,
      # via GitHub OIDC — not by a developer's local key or an unknown workflow.
      - name: verify cosign signature
        env:
          IMAGE_REF: ${{ env.IMAGE_REF }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "Verifying cosign signature for: $IMAGE_REF"
          cosign verify "$IMAGE_REF" \
            --certificate-identity-regexp="https://github.com/${GITHUB_REPOSITORY}/.github/workflows/build-sign.yaml" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            | python3 -m json.tool | head -30
          echo "cosign signature: VERIFIED"

      # ── Gate 2: SLSA provenance attestation ───────────────────────────────────
      # Verifies the GitHub-native SLSA v1.0 provenance attestation.
      # Proves the exact commit, repo, and workflow that produced this image.
      # gh attestation verify checks the Sigstore bundle in the GitHub attestation store.
      - name: verify SLSA provenance attestation (gh attestation)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_REF: ${{ env.IMAGE_REF }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          echo "Verifying SLSA provenance for: $IMAGE_REF"
          gh attestation verify "oci://$IMAGE_REF" \
            --owner "$GITHUB_REPOSITORY_OWNER" \
            --predicate-type "https://slsa.dev/provenance/v1"
          echo "SLSA provenance: VERIFIED"

      # ── Gate 3: SBOM attestation ───────────────────────────────────────────────
      # Verifies that an SPDX SBOM attestation exists for this exact image digest.
      # Ensures a bill of materials was generated and attested — not just claimed.
      - name: verify SBOM attestation (gh attestation)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_REF: ${{ env.IMAGE_REF }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          echo "Verifying SBOM attestation for: $IMAGE_REF"
          gh attestation verify "oci://$IMAGE_REF" \
            --owner "$GITHUB_REPOSITORY_OWNER" \
            --predicate-type "https://spdx.dev/Document"
          echo "SBOM attestation: VERIFIED"

      # ── Summary ───────────────────────────────────────────────────────────────
      - name: write deployment gate summary
        env:
          IMAGE_DIGEST: ${{ inputs.image_digest }}
          DEPLOY_ENV: ${{ inputs.environment }}
          IMAGE_REF: ${{ env.IMAGE_REF }}
        run: |
          echo "### Deployment Gate: All checks passed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Result |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| cosign signature | ✅ Verified (keyless OIDC) |" >> "$GITHUB_STEP_SUMMARY"
          echo "| SLSA v1.0 provenance | ✅ Verified |" >> "$GITHUB_STEP_SUMMARY"
          echo "| SBOM attestation (SPDX) | ✅ Verified |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Image:** \`$IMAGE_REF\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Environment:** \`$DEPLOY_ENV\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "> Deployment is authorized to proceed." >> "$GITHUB_STEP_SUMMARY"

  # ── Deployment placeholder ────────────────────────────────────────────────────
  # Replace this job with your actual deploy steps (helm upgrade, kubectl set image, etc.)
  # The `needs: verify-attestations` ensures it only runs after all gates pass.
  deploy:
    name: deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: verify-attestations
    environment: ${{ inputs.environment }}

    steps:
      - name: deploy (replace with your actual deploy steps)
        env:
          IMAGE_DIGEST: ${{ inputs.image_digest }}
          DEPLOY_ENV: ${{ inputs.environment }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "All attestation gates passed."
          echo "Deploying ghcr.io/${GITHUB_REPOSITORY}@${IMAGE_DIGEST} to ${DEPLOY_ENV}"
          echo ""
          echo "-- Replace this step with: --"
          echo "  helm upgrade my-app ./chart --set image.digest=${IMAGE_DIGEST}"
          echo "  kubectl set image deployment/app container=ghcr.io/${GITHUB_REPOSITORY}@${IMAGE_DIGEST}"
          echo "  etc."
