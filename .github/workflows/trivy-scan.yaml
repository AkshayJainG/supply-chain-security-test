name: "Trivy Scan"

on:
  pull_request:
    branches: [main]

jobs:
  image-scan:
    name: trivy image scan + copa patch
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

      - name: start local registry (copa needs to pull/push via registry)
        run: |
          docker run -d -p 5000:5000 --name local-registry registry:2
          sleep 2

      - name: start buildkitd (copa requires buildkit daemon)
        run: |
          curl -sSL \
            https://github.com/moby/buildkit/releases/download/v0.17.3/buildkit-v0.17.3.linux-amd64.tar.gz \
            | sudo tar xz -C /usr/local/
          sudo buildkitd &
          sleep 5
          sudo buildctl debug workers && echo "buildkitd is ready"

      - name: build image and push to local registry
        run: |
          docker build -t localhost:5000/test-image:pr .
          docker push localhost:5000/test-image:pr

      - name: trivy scan — generate json report for copa
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: image
          image-ref: localhost:5000/test-image:pr
          scanners: vuln
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "0"
          format: json
          output: trivy-report.json

      - name: show CVE summary
        run: |
          echo "=== Fixable CVEs (HIGH/CRITICAL) ==="
          python3 - <<'EOF'
          import json
          with open("trivy-report.json") as f:
              data = json.load(f)
          total = 0
          for result in data.get("Results", []):
              for vuln in result.get("Vulnerabilities", []):
                  if vuln.get("FixedVersion"):
                      print(f"  {vuln['VulnerabilityID']} | {vuln['PkgName']} {vuln['InstalledVersion']} -> {vuln['FixedVersion']} | {vuln['Severity']}")
                      total += 1
          print(f"\nTotal fixable: {total}")
          EOF

      - name: install copa v0.13.0
        run: |
          curl -sSL \
            https://github.com/project-copacetic/copacetic/releases/download/v0.13.0/copa_0.13.0_linux_amd64.tar.gz \
            | tar xz -C /usr/local/bin
          copa version

      - name: copa patch — fix OS-level CVEs without rebuild
        id: copa
        run: |
          copa patch \
            --image localhost:5000/test-image:pr \
            --report trivy-report.json \
            --tag localhost:5000/test-image:patched
        continue-on-error: true

      - name: trivy re-scan patched image — fail if unfixed CVEs remain
        if: steps.copa.outcome == 'success'
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: image
          image-ref: localhost:5000/test-image:patched
          scanners: vuln
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"
          format: table

      - name: trivy re-scan original if copa skipped
        if: steps.copa.outcome != 'success'
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: image
          image-ref: localhost:5000/test-image:pr
          scanners: vuln
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"
          format: table

      - name: upload trivy report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: trivy-report
          path: trivy-report.json
          if-no-files-found: ignore
