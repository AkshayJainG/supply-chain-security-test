name: "Trivy Scan"

on:
  pull_request:
    branches: [main]

jobs:
  image-scan:
    name: trivy image scan + copa patch
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

      - name: enable containerd image store in Docker (required by copa for mergeop/diffop)
        run: |
          echo '{"features": {"containerd-snapshotter": true}}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          sleep 5
          docker info | grep -i "storage driver"

      - name: start local registry (copa pulls/pushes via registry)
        run: |
          docker run -d -p 5000:5000 --name local-registry registry:2
          sleep 2

      - name: build image and push to local registry
        run: |
          docker build -t localhost:5000/test-image:pr .
          docker push localhost:5000/test-image:pr

      - name: trivy scan — generate json report for copa
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: image
          image-ref: localhost:5000/test-image:pr
          scanners: vuln
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "0"
          format: json
          output: trivy-report.json

      - name: show CVE summary
        run: |
          echo "=== Fixable CVEs (HIGH/CRITICAL) ==="
          python3 - <<'EOF'
          import json
          with open("trivy-report.json") as f:
              data = json.load(f)
          total = 0
          for result in data.get("Results", []):
              for vuln in result.get("Vulnerabilities", []):
                  if vuln.get("FixedVersion"):
                      print(f"  {vuln['VulnerabilityID']} | {vuln['PkgName']} {vuln['InstalledVersion']} -> {vuln['FixedVersion']} | {vuln['Severity']}")
                      total += 1
          print(f"\nTotal fixable: {total}")
          EOF

      - name: install copa v0.13.0
        run: |
          curl -sSL \
            https://github.com/project-copacetic/copacetic/releases/download/v0.13.0/copa_0.13.0_linux_amd64.tar.gz \
            | sudo tar xz -C /usr/local/bin
          copa --version

      - name: copa patch — fix OS-level CVEs without rebuild
        run: |
          COPA_OUT=$(copa patch \
            --image localhost:5000/test-image:pr \
            --report trivy-report.json \
            --tag localhost:5000/test-image:patched 2>&1) || true
          echo "$COPA_OUT"
          if echo "$COPA_OUT" | grep -q "no package updates found"; then
            echo "Copa: no OS patches available in Debian repo — image is at latest patchable state"
            docker pull localhost:5000/test-image:pr
            docker tag localhost:5000/test-image:pr localhost:5000/test-image:patched
            docker push localhost:5000/test-image:patched
            echo "COPA_DID_PATCH=false" >> "$GITHUB_ENV"
          else
            echo "COPA_DID_PATCH=true" >> "$GITHUB_ENV"
          fi

      # Gate: only fail if Copa actually had patches to apply (same logic as build-sign.yaml)
      - name: trivy re-scan OS packages — fail if copa missed any
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: image
          image-ref: localhost:5000/test-image:patched
          scanners: vuln
          vuln-type: os
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: ${{ env.COPA_DID_PATCH == 'true' && '1' || '0' }}
          format: table

      - name: upload trivy report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: trivy-report
          path: trivy-report.json
          if-no-files-found: ignore
