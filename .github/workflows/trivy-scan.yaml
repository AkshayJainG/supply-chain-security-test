name: "Trivy Scan"

on:
  pull_request:
    branches: [main]

jobs:
  image-scan:
    name: trivy image scan + copa patch
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

      - name: set up buildx (required by copa)
        id: buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: build image locally for scanning
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: .
          push: false
          load: true
          tags: test-image:pr
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: trivy scan — generate report for copa
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: image
          image-ref: test-image:pr
          scanners: vuln
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "0"
          format: json
          output: trivy-report.json

      - name: show CVE summary
        run: |
          echo "=== CVEs found (HIGH/CRITICAL, fixable) ==="
          python3 - <<'EOF'
          import json
          with open("trivy-report.json") as f:
              data = json.load(f)
          total = 0
          for result in data.get("Results", []):
              for vuln in result.get("Vulnerabilities", []):
                  if vuln.get("FixedVersion"):
                      print(f"  {vuln['VulnerabilityID']} | {vuln['PkgName']} {vuln['InstalledVersion']} -> {vuln['FixedVersion']} | {vuln['Severity']}")
                      total += 1
          print(f"\nTotal fixable: {total}")
          EOF

      - name: install copa v0.13.0
        run: |
          curl -sSL \
            https://github.com/project-copacetic/copacetic/releases/download/v0.13.0/copa_0.13.0_linux_amd64.tar.gz \
            | tar xz -C /usr/local/bin
          copa version

      - name: copa patch — fix OS-level CVEs in-place
        id: copa
        env:
          BUILDX_ADDR: ${{ steps.buildx.outputs.endpoint }}
        run: |
          copa patch \
            --image test-image:pr \
            --report trivy-report.json \
            --tag test-image:patched \
            --addr "$BUILDX_ADDR"
        continue-on-error: true

      - name: trivy re-scan patched image — fail if unfixed CVEs remain
        if: steps.copa.outcome == 'success'
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: image
          image-ref: test-image:patched
          scanners: vuln
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"
          format: table

      - name: trivy re-scan original if copa skipped
        if: steps.copa.outcome != 'success'
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          scan-type: image
          image-ref: test-image:pr
          scanners: vuln
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"
          format: table

      - name: upload trivy report artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: trivy-report
          path: trivy-report.json
          if-no-files-found: ignore
