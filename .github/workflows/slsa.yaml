name: "SLSA Provenance (Release)"

# This workflow generates SLSA provenance for release tarballs.
# Container image provenance is handled inline in build-sign.yaml via
# actions/attest-build-provenance which produces SLSA v1.0.
#
# Verify with: gh attestation verify <artifact> --owner AkshayJainG

on:
  release:
    types: [published]

jobs:
  release-provenance:
    name: build + attest release artifact
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: checkout at release tag
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
        with:
          fetch-depth: 0

      - name: build release artifact
        run: |
          tar czf release.tar.gz --exclude='.git' --exclude='.github' .
          sha256sum release.tar.gz > checksums.txt
          cat checksums.txt

      - name: generate SLSA provenance for release tarball
        id: attest
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2.4.0
        with:
          subject-path: release.tar.gz

      - name: upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUNDLE_PATH: ${{ steps.attest.outputs.bundle-path }}
        run: |
          gh release upload "$GITHUB_REF_NAME" \
            release.tar.gz \
            checksums.txt
          echo "Provenance bundle: $BUNDLE_PATH"
          echo ""
          echo "Verify with: gh attestation verify release.tar.gz --owner AkshayJainG"
