name: "Secret Scan (Kingfisher)"

on:
  pull_request:
    branches: [main]
  # Also scan direct pushes to main (e.g. admin bypasses branch protection)
  push:
    branches: [main]

jobs:
  secret-scan:
    name: kingfisher scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: checkout (full history needed for commit range)
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: install kingfisher v1.83.0
        run: |
          curl -sSL \
            https://github.com/mongodb/kingfisher/releases/download/v1.83.0/kingfisher-linux-x64.tgz \
            | tar xz -C /usr/local/bin
          kingfisher --version

      - name: scan commits introduced by this push/PR
        run: |
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            # PR: scan only the diff vs merge base — no user-controlled input
            MERGE_BASE=$(git merge-base origin/main HEAD)
            echo "PR scan since merge base: $MERGE_BASE"
            kingfisher scan . \
              --since-commit "$MERGE_BASE" \
              --format sarif \
              --output kingfisher-findings.sarif
          else
            # Push to main: scan the pushed commits only
            # GITHUB_SHA is the after-commit; the before is available via event payload
            BEFORE=$(git rev-parse HEAD~1 2>/dev/null || git rev-parse HEAD)
            echo "Push scan since: $BEFORE"
            kingfisher scan . \
              --since-commit "$BEFORE" \
              --format sarif \
              --output kingfisher-findings.sarif
          fi
          # Exit 0 = clean
          # Exit 200 = findings → fails step → blocks merge / alerts on push
          # Exit 205 = live/validated secrets

      - name: upload SARIF findings
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: kingfisher-sarif
          path: kingfisher-findings.sarif
          if-no-files-found: ignore
