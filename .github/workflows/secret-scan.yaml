name: "Secret Scan (Kingfisher)"

on:
  pull_request:
    branches: [main]

jobs:
  secret-scan:
    name: kingfisher PR scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: checkout (full history needed for commit range diff)
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
        with:
          fetch-depth: 0

      - name: install kingfisher v1.83.0
        run: |
          curl -sSL \
            https://github.com/mongodb/kingfisher/releases/download/v1.83.0/kingfisher-linux-x64.tgz \
            | tar xz -C /usr/local/bin
          kingfisher --version

      - name: scan only commits introduced by this PR
        run: |
          # Compute the merge base from git itself — no user-controlled input
          MERGE_BASE=$(git merge-base origin/main HEAD)
          echo "Scanning commits since merge base: $MERGE_BASE"
          kingfisher scan . \
            --since-commit "$MERGE_BASE" \
            --format sarif \
            --output kingfisher-findings.sarif
          # Exit 0 = clean
          # Exit 200 = findings detected → step fails → PR blocked
          # Exit 205 = live/validated secrets found → PR blocked

      - name: upload SARIF findings artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: kingfisher-sarif
          path: kingfisher-findings.sarif
          if-no-files-found: ignore
